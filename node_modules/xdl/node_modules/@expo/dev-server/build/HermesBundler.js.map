{"version":3,"file":"HermesBundler.js","sourceRoot":"","sources":["../src/HermesBundler.ts"],"names":[],"mappings":";;;;;;AACA,oEAA2C;AAC3C,wDAA0B;AAE1B,4CAAoB;AACpB,gDAAwB;AACxB,sDAA8B;AAC9B,gEAAuC;AAEhC,KAAK,UAAU,4BAA4B,CAChD,WAAmB,EACnB,QAAkB;IAElB,IAAI,QAAQ,KAAK,SAAS,EAAE;QAC1B,MAAM,oBAAoB,GAAG,cAAI,CAAC,IAAI,CAAC,WAAW,EAAE,SAAS,EAAE,mBAAmB,CAAC,CAAC;QACpF,IAAI,CAAC,kBAAE,CAAC,UAAU,CAAC,oBAAoB,CAAC,EAAE;YACxC,2FAA2F;YAC3F,OAAO,KAAK,CAAC;SACd;QACD,MAAM,UAAU,GAAG,qBAAqB,CAAC,MAAM,kBAAE,CAAC,QAAQ,CAAC,oBAAoB,EAAE,MAAM,CAAC,CAAC,CAAC;QAC1F,IAAI,UAAU,CAAC,YAAY,CAAC,KAAK,QAAQ,EAAE;YACzC,OAAO,IAAI,CAAC;SACb;KACF;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAhBD,oEAgBC;AAMM,KAAK,UAAU,sBAAsB,CAC1C,WAAmB,EACnB,IAAY,EACZ,GAAW,EACX,WAAoB,KAAK;IAEzB,MAAM,OAAO,GAAG,cAAI,CAAC,IAAI,CAAC,YAAE,CAAC,MAAM,EAAE,EAAE,gBAAgB,iBAAO,CAAC,GAAG,EAAE,CAAC,CAAC;IACtE,MAAM,kBAAE,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;IAC5B,IAAI;QACF,MAAM,cAAc,GAAG,cAAI,CAAC,IAAI,CAAC,OAAO,EAAE,cAAc,CAAC,CAAC;QAC1D,MAAM,iBAAiB,GAAG,cAAI,CAAC,IAAI,CAAC,OAAO,EAAE,kBAAkB,CAAC,CAAC;QACjE,MAAM,kBAAE,CAAC,SAAS,CAAC,cAAc,EAAE,IAAI,CAAC,CAAC;QACzC,MAAM,kBAAE,CAAC,SAAS,CAAC,iBAAiB,EAAE,GAAG,CAAC,CAAC;QAE3C,MAAM,WAAW,GAAG,cAAI,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,CAAC;QACpD,MAAM,aAAa,GAAG,gBAAgB,CAAC,WAAW,CAAC,CAAC;QACpD,MAAM,IAAI,GAAG,CAAC,cAAc,EAAE,MAAM,EAAE,WAAW,EAAE,cAAc,EAAE,oBAAoB,CAAC,CAAC;QACzF,IAAI,QAAQ,EAAE;YACZ,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;SACjB;QACD,MAAM,qBAAU,CAAC,aAAa,EAAE,IAAI,CAAC,CAAC;QAEtC,MAAM,CAAC,GAAG,EAAE,SAAS,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;YACzC,kBAAE,CAAC,QAAQ,CAAC,WAAW,CAAC;YACxB,0BAA0B,CAAC,WAAW,EAAE,GAAG,EAAE,GAAG,WAAW,MAAM,CAAC;SACnE,CAAC,CAAC;QACH,OAAO;YACL,GAAG;YACH,SAAS;SACV,CAAC;KACH;YAAS;QACR,MAAM,kBAAE,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;KAC1B;AACH,CAAC;AAjCD,wDAiCC;AAEM,KAAK,UAAU,0BAA0B,CAC9C,WAAmB,EACnB,SAAiB,EACjB,aAAqB;IAErB,MAAM,iBAAiB,GAAG,+BAA+B,CAAC,WAAW,CAAC,CAAC;IACvE,MAAM,gBAAgB,GAAG,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,CAAC;IAC/C,MAAM,eAAe,GAAG,MAAM,kBAAE,CAAC,QAAQ,CAAC,aAAa,CAAC,CAAC;IACzD,OAAO,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAC,CAAC,gBAAgB,EAAE,eAAe,CAAC,CAAC,CAAC,CAAC;AAChF,CAAC;AATD,gEASC;AAED,SAAS,gBAAgB,CAAC,WAAmB;IAC3C,MAAM,QAAQ,GAAG,wBAAwB,EAAE,CAAC;IAC5C,MAAM,YAAY,GAAG,sBAAW,CAAC,MAAM,CAAC,WAAW,EAAE,iBAAiB,QAAQ,UAAU,CAAC,CAAC;IAC1F,IAAI,CAAC,YAAY,EAAE;QACjB,MAAM,IAAI,KAAK,CACb,iCAAiC,QAAQ,2BAA2B;YAClE,qDAAqD;YACrD,yEAAyE;YACzE,kCAAkC,CACrC,CAAC;KACH;IACD,OAAO,YAAY,CAAC;AACtB,CAAC;AAED,SAAS,wBAAwB;IAC/B,QAAQ,YAAE,CAAC,QAAQ,EAAE,EAAE;QACrB,KAAK,QAAQ;YACX,OAAO,SAAS,CAAC;QACnB,KAAK,OAAO;YACV,OAAO,aAAa,CAAC;QACvB,KAAK,OAAO;YACV,OAAO,WAAW,CAAC;QACrB;YACE,MAAM,IAAI,KAAK,CAAC,kDAAkD,YAAE,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;KACtF;AACH,CAAC;AAED,SAAgB,qBAAqB,CAAC,OAAe;IACnD,MAAM,MAAM,GAA2B,EAAE,CAAC;IAC1C,KAAK,IAAI,IAAI,IAAI,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;QACpC,IAAI,GAAG,IAAI,CAAC,IAAI,EAAE,CAAC;QACnB,IAAI,CAAC,IAAI,IAAI,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE;YACjC,SAAS;SACV;QAED,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QACnC,MAAM,GAAG,GAAG,IAAI,CAAC,MAAM,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC;QACrC,MAAM,KAAK,GAAG,IAAI,CAAC,MAAM,CAAC,QAAQ,GAAG,CAAC,CAAC,CAAC;QACxC,MAAM,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC;KACrB;IACD,OAAO,MAAM,CAAC;AAChB,CAAC;AAdD,sDAcC;AAED,SAAS,+BAA+B,CAAC,WAAmB;IAC1D,MAAM,YAAY,GAAG,sBAAW,CAAC,MAAM,CAAC,WAAW,EAAE,wCAAwC,CAAC,CAAC;IAC/F,IAAI,CAAC,YAAY,EAAE;QACjB,MAAM,IAAI,KAAK,CACb,0EAA0E;YACxE,oDAAoD;YACpD,yEAAyE;YACzE,kCAAkC,CACrC,CAAC;KACH;IACD,OAAO,OAAO,CAAC,YAAY,CAAC,CAAC;AAC/B,CAAC;AAED,6GAA6G;AAC7G,MAAM,mBAAmB,GAAG,kBAAkB,CAAC;AAExC,KAAK,UAAU,2BAA2B,CAAC,IAAY;IAC5D,MAAM,MAAM,GAAG,MAAM,qBAAqB,CAAC,IAAI,CAAC,CAAC;IACjD,OAAO,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,KAAK,mBAAmB,CAAC;AACpE,CAAC;AAHD,kEAGC;AAEM,KAAK,UAAU,mCAAmC,CAAC,IAAY;IACpE,MAAM,MAAM,GAAG,MAAM,qBAAqB,CAAC,IAAI,CAAC,CAAC;IACjD,IAAI,MAAM,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,QAAQ,CAAC,KAAK,CAAC,KAAK,mBAAmB,EAAE;QAC9D,MAAM,IAAI,KAAK,CAAC,4BAA4B,CAAC,CAAC;KAC/C;IACD,OAAO,MAAM,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC;AAChC,CAAC;AAND,kFAMC;AAED,KAAK,UAAU,qBAAqB,CAAC,IAAY;IAC/C,MAAM,EAAE,GAAG,MAAM,kBAAE,CAAC,IAAI,CAAC,IAAI,EAAE,GAAG,CAAC,CAAC;IACpC,MAAM,MAAM,GAAG,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;IAChC,MAAM,kBAAE,CAAC,IAAI,CAAC,EAAE,EAAE,MAAM,EAAE,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,CAAC;IACvC,MAAM,kBAAE,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC;IACnB,OAAO,MAAM,CAAC;AAChB,CAAC","sourcesContent":["import type { Platform } from '@expo/config';\nimport spawnAsync from '@expo/spawn-async';\nimport fs from 'fs-extra';\nimport type { composeSourceMaps } from 'metro-source-map';\nimport os from 'os';\nimport path from 'path';\nimport process from 'process';\nimport resolveFrom from 'resolve-from';\n\nexport async function shouldBuildHermesBundleAsync(\n  projectRoot: string,\n  platform: Platform\n): Promise<boolean> {\n  if (platform === 'android') {\n    const gradlePropertiesPath = path.join(projectRoot, 'android', 'gradle.properties');\n    if (!fs.existsSync(gradlePropertiesPath)) {\n      // TODO(kudo): Clarify default behavior in managed workflow for gradle.properties not exist\n      return false;\n    }\n    const properties = parseGradleProperties(await fs.readFile(gradlePropertiesPath, 'utf8'));\n    if (properties['JS_RUNTIME'] === 'hermes') {\n      return true;\n    }\n  }\n  return false;\n}\n\ninterface HermesBundleOutput {\n  hbc: Uint8Array;\n  sourcemap: string;\n}\nexport async function buildHermesBundleAsync(\n  projectRoot: string,\n  code: string,\n  map: string,\n  optimize: boolean = false\n): Promise<HermesBundleOutput> {\n  const tempDir = path.join(os.tmpdir(), `expo-bundler-${process.pid}`);\n  await fs.ensureDir(tempDir);\n  try {\n    const tempBundleFile = path.join(tempDir, 'index.bundle');\n    const tempSourcemapFile = path.join(tempDir, 'index.bundle.map');\n    await fs.writeFile(tempBundleFile, code);\n    await fs.writeFile(tempSourcemapFile, map);\n\n    const tempHbcFile = path.join(tempDir, 'index.hbc');\n    const hermesCommand = getHermesCommand(projectRoot);\n    const args = ['-emit-binary', '-out', tempHbcFile, tempBundleFile, '-output-source-map'];\n    if (optimize) {\n      args.push('-O');\n    }\n    await spawnAsync(hermesCommand, args);\n\n    const [hbc, sourcemap] = await Promise.all([\n      fs.readFile(tempHbcFile),\n      createHermesSourcemapAsync(projectRoot, map, `${tempHbcFile}.map`),\n    ]);\n    return {\n      hbc,\n      sourcemap,\n    };\n  } finally {\n    await fs.remove(tempDir);\n  }\n}\n\nexport async function createHermesSourcemapAsync(\n  projectRoot: string,\n  sourcemap: string,\n  hermesMapFile: string\n): Promise<string> {\n  const composeSourceMaps = importMetroSourceMapFromProject(projectRoot);\n  const bundlerSourcemap = JSON.parse(sourcemap);\n  const hermesSourcemap = await fs.readJSON(hermesMapFile);\n  return JSON.stringify(composeSourceMaps([bundlerSourcemap, hermesSourcemap]));\n}\n\nfunction getHermesCommand(projectRoot: string): string {\n  const platform = getHermesCommandPlatform();\n  const resolvedPath = resolveFrom.silent(projectRoot, `hermes-engine/${platform}/hermesc`);\n  if (!resolvedPath) {\n    throw new Error(\n      `Missing module \"hermes-engine/${platform}/hermesc\" in the project.` +\n        'This usually means hermes-engine is not installed. ' +\n        'Please verify that dependencies in package.json include \"react-native\" ' +\n        'and run `yarn` or `npm install`.'\n    );\n  }\n  return resolvedPath;\n}\n\nfunction getHermesCommandPlatform(): string {\n  switch (os.platform()) {\n    case 'darwin':\n      return 'osx-bin';\n    case 'linux':\n      return 'linux64-bin';\n    case 'win32':\n      return 'win64-bin';\n    default:\n      throw new Error(`Unsupported host platform for Hermes compiler: ${os.platform()}`);\n  }\n}\n\nexport function parseGradleProperties(content: string): Record<string, string> {\n  const result: Record<string, string> = {};\n  for (let line of content.split('\\n')) {\n    line = line.trim();\n    if (!line || line.startsWith('#')) {\n      continue;\n    }\n\n    const sepIndex = line.indexOf('=');\n    const key = line.substr(0, sepIndex);\n    const value = line.substr(sepIndex + 1);\n    result[key] = value;\n  }\n  return result;\n}\n\nfunction importMetroSourceMapFromProject(projectRoot: string): typeof composeSourceMaps {\n  const resolvedPath = resolveFrom.silent(projectRoot, 'metro-source-map/src/composeSourceMaps');\n  if (!resolvedPath) {\n    throw new Error(\n      'Missing module \"metro-source-map/src/composeSourceMaps\" in the project. ' +\n        'This usually means React Native is not installed. ' +\n        'Please verify that dependencies in package.json include \"react-native\" ' +\n        'and run `yarn` or `npm install`.'\n    );\n  }\n  return require(resolvedPath);\n}\n\n// https://github.com/facebook/hermes/blob/release-v0.5/include/hermes/BCGen/HBC/BytecodeFileFormat.h#L24-L25\nconst HERMES_MAGIC_HEADER = 'c61fbc03c103191f';\n\nexport async function isHermesBytecodeBundleAsync(file: string): Promise<boolean> {\n  const header = await readHermesHeaderAsync(file);\n  return header.slice(0, 8).toString('hex') === HERMES_MAGIC_HEADER;\n}\n\nexport async function getHermesBytecodeBundleVersionAsync(file: string): Promise<number> {\n  const header = await readHermesHeaderAsync(file);\n  if (header.slice(0, 8).toString('hex') !== HERMES_MAGIC_HEADER) {\n    throw new Error('Invalid hermes bundle file');\n  }\n  return header.readUInt32LE(8);\n}\n\nasync function readHermesHeaderAsync(file: string): Promise<Buffer> {\n  const fd = await fs.open(file, 'r');\n  const buffer = Buffer.alloc(12);\n  await fs.read(fd, buffer, 0, 12, null);\n  await fs.close(fd);\n  return buffer;\n}\n"]}