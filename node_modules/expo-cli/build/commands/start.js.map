{"version":3,"sources":["../../src/commands/start.ts"],"names":["action","projectRoot","options","Log","log","chalk","gray","hasExpoInstalled","resolveFrom","silent","ConfigError","exp","pkg","getConfig","skipSDKVersionRequirement","webOnly","urlOpts","optsAsync","rootPath","path","resolve","tryOpeningDevToolsAsync","Versions","gteSdkVersion","ensureTypeScriptSetupAsync","validateDependenciesVersionsAsync","assertProjectHasExpoExtensionFilesAsync","startOptions","parseStartOptions","Project","startAsync","url","UrlUtils","constructDeepLinkAsync","recipient","sendTo","getRecipient","sendUrlAsync","handleMobileOptsAsync","isTerminalUIEnabled","nonInteractive","isDetached","TerminalUI","newLine","printQRCode","underline","nested","dim","program","command","alias","description","helpGroup","option","allowOffline","asyncActionProjectDir","normalizedOptions"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAMA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAEA,eAAeA,MAAf,CAAsBC,WAAtB,EAA2CC,OAA3C,EAAsF;AACpFC,iBAAIC,GAAJ,CAAQC,iBAAMC,IAAN,CAAY,uBAAsBL,WAAY,EAA9C,CAAR,EADoF,CAGpF;;;AACA,4CAAiBA,WAAjB,EAJoF,CAMpF;;AACA,QAAMM,gBAAgB,GAAGC,uBAAYC,MAAZ,CAAmBR,WAAnB,EAAgC,MAAhC,CAAzB;;AAEA,MAAI,CAACM,gBAAL,EAAuB;AACrB,UAAM,KAAIG,qBAAJ,EACH,4EADG,EAEJ,kBAFI,CAAN;AAID;;AAED,QAAM;AAAEC,IAAAA,GAAF;AAAOC,IAAAA;AAAP,MAAe,oCAAcC,mBAAd,EAAyBZ,WAAzB,EAAsC;AACzDa,IAAAA,yBAAyB,EAAEZ,OAAO,CAACa;AADsB,GAAtC,CAArB,CAhBoF,CAoBpF;AACA;;AACA,QAAM,oCAAcC,mBAAQC,SAAtB,EAAiChB,WAAjC,EAA8CC,OAA9C,CAAN,CAtBoF,CAwBpF;;AACA,QAAMgB,QAAQ,GAAGC,gBAAKC,OAAL,CAAanB,WAAb,CAAjB,CAzBoF,CA2BpF;;;AACA,QAAM,oCAAcoB,uCAAd,EAAuCH,QAAvC,EAAiD;AACrDP,IAAAA,GADqD;AAErDT,IAAAA;AAFqD,GAAjD,CAAN;;AAKA,MAAIoB,gBAASC,aAAT,CAAuBZ,GAAvB,EAA4B,QAA5B,CAAJ,EAA2C;AACzC,UAAM,oCAAca,mDAAd,EAA0CvB,WAA1C,CAAN;AACD;;AAED,MAAI,CAACC,OAAO,CAACa,OAAb,EAAsB;AACpB;AACA,UAAM,oCAAcU,iEAAd,EAAiDxB,WAAjD,EAA8DU,GAA9D,EAAmEC,GAAnE,CAAN,CAFoB,CAGpB;;AACA,QAAI,CAAC,sCAAuBD,GAAvB,CAAL,EAAkC;AAChC;AACA;AACA,YAAM,oCAAce,sEAAd,EAAuDzB,WAAvD,CAAN;AACD;AACF;;AAED,QAAM0B,YAAY,GAAG,oCAAcC,sCAAd,EAAiC1B,OAAjC,EAA0CS,GAA1C,CAArB;AAEA,QAAM,oCAAckB,eAAQC,UAAtB,EAAkCZ,QAAlC,EAA4C,EAAE,GAAGS,YAAL;AAAmBhB,IAAAA;AAAnB,GAA5C,CAAN,CAlDoF,CAoDpF;;AACA,QAAMoB,GAAG,GAAG,MAAM,oCAChBC,gBAASC,sBADO,EAEhB,iCAFgB,EAGhBhC,WAHgB,CAAlB;AAIA,QAAMiC,SAAS,GAAG,MAAM,oCAAcC,MAAM,GAACC,YAArB,EAAmClC,OAAO,CAACiC,MAA3C,CAAxB;;AACA,MAAID,SAAJ,EAAe;AACb,UAAMC,MAAM,GAACE,YAAP,CAAoBN,GAApB,EAAyBG,SAAzB,CAAN;AACD,GA5DmF,CA8DpF;;;AACA,QAAM,oCAAclB,mBAAQsB,qBAAtB,EAA6CrC,WAA7C,EAA0DC,OAA1D,CAAN,CA/DoF,CAiEpF;;AACA,QAAMqC,mBAAmB,GAAG,CAACrC,OAAO,CAACsC,cAAT,IAA2B,CAAC7B,GAAG,CAAC8B,UAA5D;;AAEA,MAAIF,mBAAJ,EAAyB;AACvB,UAAM,oCAAcG,UAAU,GAACZ,UAAzB,EAAqC,uBAArC,EAA8D7B,WAA9D,EAA2E0B,YAA3E,CAAN;AACD,GAFD,MAEO;AACL,QAAI,CAAChB,GAAG,CAAC8B,UAAT,EAAqB;AACnBtC,qBAAIwC,OAAJ;;AACA3B,yBAAQ4B,WAAR,CAAoBb,GAApB;AACD;;AACD5B,mBAAIC,GAAJ,CAAS,iCAAgCC,iBAAMwC,SAAN,CAAgBd,GAAhB,CAAqB,EAA9D;AACD,GA5EmF,CA8EpF;;;AACA,MAAI,CAAC7B,OAAO,CAACa,OAAb,EAAsB;AACpBZ,mBAAI2C,MAAJ,CAAY,4CAA2CzC,iBAAM0C,GAAN,CAAW,uBAAX,CAAmC,EAA1F;AACD,GAFD,MAEO;AACL5C,mBAAI2C,MAAJ,CACG,+DAA8DzC,iBAAM0C,GAAN,CAC5D,uBAD4D,CAE7D,EAHJ;AAKD;AACF;;eAEeC,OAAD,IAAkB;AAC/BA,EAAAA,OAAO,CACJC,OADH,CACW,cADX,EAEGC,KAFH,CAES,GAFT,EAGGC,WAHH,CAGe,sCAHf,EAIGC,SAJH,CAIa,MAJb,EAKGC,MALH,CAKU,sBALV,EAKkC,oCALlC,EAMGA,MANH,CAMU,aANV,EAMyB,+BANzB,EAOE;AAPF,GAQGA,MARH,CAQU,qBARV,EAQiC,kDARjC,EASGA,MATH,CASU,OATV,EASmB,0BATnB,EAUGA,MAVH,CAUU,UAVV,EAUsB,2BAVtB,EAWGA,MAXH,CAWU,UAXV,EAWsB,aAXtB,EAYGA,MAZH,CAYU,aAZV,EAYyB,oBAZzB,EAaGA,MAbH,CAaU,SAbV,EAaqB,sCAbrB,EAcGA,MAdH,CAcU,YAdV,EAcwB,qCAdxB,EAeGrC,OAfH,GAgBGsC,YAhBH,GAiBGC,qBAjBH,CAkBI,OAAOtD,WAAP,EAA4BC,OAA5B,KAAwE;AACtE,UAAMsD,iBAAiB,GAAG,MAAM,gDAAsBvD,WAAtB,EAAmCC,OAAnC,CAAhC;AACA,WAAO,MAAMF,MAAM,CAACC,WAAD,EAAcuD,iBAAd,CAAnB;AACD,GArBL;AAwBAR,EAAAA,OAAO,CACJC,OADH,CACW,kBADX,EAEGC,KAFH,CAES,KAFT,EAGGC,WAHH,CAGe,4CAHf,EAIGC,SAJH,CAIa,MAJb,EAKGC,MALH,CAKU,OALV,EAKmB,0BALnB,EAMGA,MANH,CAMU,UANV,EAMsB,2BANtB,EAOGA,MAPH,CAOU,UAPV,EAOsB,aAPtB,EAQGA,MARH,CAQU,aARV,EAQyB,oBARzB,EASGA,MATH,CASU,SATV,EASqB,sCATrB,EAUGA,MAVH,CAUU,YAVV,EAUwB,qCAVxB,EAWGA,MAXH,CAWU,sBAXV,EAWkC,oCAXlC,EAYGrC,OAZH,GAaGsC,YAbH,GAcGC,qBAdH,CAeI,OAAOtD,WAAP,EAA4BC,OAA5B,KAAwE;AACtE,UAAMsD,iBAAiB,GAAG,MAAM,gDAAsBvD,WAAtB,EAAmC,EACjE,GAAGC,OAD8D;AAEjEa,MAAAA,OAAO,EAAE;AAFwD,KAAnC,CAAhC;AAIA,WAAO,MAAMf,MAAM,CAACC,WAAD,EAAcuD,iBAAd,CAAnB;AACD,GArBL;AAuBD,C","sourcesContent":["import { ConfigError, getConfig, isLegacyImportsEnabled } from '@expo/config';\nimport chalk from 'chalk';\nimport path from 'path';\nimport resolveFrom from 'resolve-from';\nimport { Project, UrlUtils, Versions } from 'xdl';\n\nimport Log from '../log';\nimport * as sendTo from '../sendTo';\nimport urlOpts from '../urlOpts';\nimport * as TerminalUI from './start/TerminalUI';\nimport { installExitHooks } from './start/installExitHooks';\nimport { tryOpeningDevToolsAsync } from './start/openDevTools';\nimport {\n  NormalizedOptions,\n  normalizeOptionsAsync,\n  parseStartOptions,\n  RawStartOptions,\n} from './start/parseStartOptions';\nimport { assertProjectHasExpoExtensionFilesAsync } from './utils/deprecatedExtensionWarnings';\nimport { profileMethod } from './utils/profileMethod';\nimport { ensureTypeScriptSetupAsync } from './utils/typescript/ensureTypeScriptSetup';\nimport { validateDependenciesVersionsAsync } from './utils/validateDependenciesVersions';\n\nasync function action(projectRoot: string, options: NormalizedOptions): Promise<void> {\n  Log.log(chalk.gray(`Starting project at ${projectRoot}`));\n\n  // Add clean up hooks\n  installExitHooks(projectRoot);\n\n  // Find expo binary in project/workspace node_modules\n  const hasExpoInstalled = resolveFrom.silent(projectRoot, 'expo');\n\n  if (!hasExpoInstalled) {\n    throw new ConfigError(\n      `Unable to find expo in this project - have you run yarn / npm install yet?`,\n      'MODULE_NOT_FOUND'\n    );\n  }\n\n  const { exp, pkg } = profileMethod(getConfig)(projectRoot, {\n    skipSDKVersionRequirement: options.webOnly,\n  });\n\n  // Assert various random things\n  // TODO: split up this method\n  await profileMethod(urlOpts.optsAsync)(projectRoot, options);\n\n  // TODO: This is useless on mac, check if useless on win32\n  const rootPath = path.resolve(projectRoot);\n\n  // Optionally open the developer tools UI.\n  await profileMethod(tryOpeningDevToolsAsync)(rootPath, {\n    exp,\n    options,\n  });\n\n  if (Versions.gteSdkVersion(exp, '34.0.0')) {\n    await profileMethod(ensureTypeScriptSetupAsync)(projectRoot);\n  }\n\n  if (!options.webOnly) {\n    // TODO: only validate dependencies if starting in managed workflow\n    await profileMethod(validateDependenciesVersionsAsync)(projectRoot, exp, pkg);\n    // Warn about expo extensions.\n    if (!isLegacyImportsEnabled(exp)) {\n      // Adds a few seconds in basic projects so we should\n      // drop this in favor of the upgrade version as soon as possible.\n      await profileMethod(assertProjectHasExpoExtensionFilesAsync)(projectRoot);\n    }\n  }\n\n  const startOptions = profileMethod(parseStartOptions)(options, exp);\n\n  await profileMethod(Project.startAsync)(rootPath, { ...startOptions, exp });\n\n  // Send to option...\n  const url = await profileMethod(\n    UrlUtils.constructDeepLinkAsync,\n    'UrlUtils.constructDeepLinkAsync'\n  )(projectRoot);\n  const recipient = await profileMethod(sendTo.getRecipient)(options.sendTo);\n  if (recipient) {\n    await sendTo.sendUrlAsync(url, recipient);\n  }\n\n  // Open project on devices.\n  await profileMethod(urlOpts.handleMobileOptsAsync)(projectRoot, options);\n\n  // Present the Terminal UI.\n  const isTerminalUIEnabled = !options.nonInteractive && !exp.isDetached;\n\n  if (isTerminalUIEnabled) {\n    await profileMethod(TerminalUI.startAsync, 'TerminalUI.startAsync')(projectRoot, startOptions);\n  } else {\n    if (!exp.isDetached) {\n      Log.newLine();\n      urlOpts.printQRCode(url);\n    }\n    Log.log(`Your native app is running at ${chalk.underline(url)}`);\n  }\n\n  // Final note about closing the server.\n  if (!options.webOnly) {\n    Log.nested(`Logs for your project will appear below. ${chalk.dim(`Press Ctrl+C to exit.`)}`);\n  } else {\n    Log.nested(\n      `\\nLogs for your project will appear in the browser console. ${chalk.dim(\n        `Press Ctrl+C to exit.`\n      )}`\n    );\n  }\n}\n\nexport default (program: any) => {\n  program\n    .command('start [path]')\n    .alias('r')\n    .description('Start a local dev server for the app')\n    .helpGroup('core')\n    .option('-s, --send-to [dest]', 'An email address to send a link to')\n    .option('-c, --clear', 'Clear the Metro bundler cache')\n    // TODO(anp) set a default for this dynamically based on whether we're inside a container?\n    .option('--max-workers [num]', 'Maximum number of tasks to allow Metro to spawn.')\n    .option('--dev', 'Turn development mode on')\n    .option('--no-dev', 'Turn development mode off')\n    .option('--minify', 'Minify code')\n    .option('--no-minify', 'Do not minify code')\n    .option('--https', 'To start webpack with https protocol')\n    .option('--no-https', 'To start webpack with http protocol')\n    .urlOpts()\n    .allowOffline()\n    .asyncActionProjectDir(\n      async (projectRoot: string, options: RawStartOptions): Promise<void> => {\n        const normalizedOptions = await normalizeOptionsAsync(projectRoot, options);\n        return await action(projectRoot, normalizedOptions);\n      }\n    );\n\n  program\n    .command('start:web [path]')\n    .alias('web')\n    .description('Start a Webpack dev server for the web app')\n    .helpGroup('core')\n    .option('--dev', 'Turn development mode on')\n    .option('--no-dev', 'Turn development mode off')\n    .option('--minify', 'Minify code')\n    .option('--no-minify', 'Do not minify code')\n    .option('--https', 'To start webpack with https protocol')\n    .option('--no-https', 'To start webpack with http protocol')\n    .option('-s, --send-to [dest]', 'An email address to send a link to')\n    .urlOpts()\n    .allowOffline()\n    .asyncActionProjectDir(\n      async (projectRoot: string, options: RawStartOptions): Promise<void> => {\n        const normalizedOptions = await normalizeOptionsAsync(projectRoot, {\n          ...options,\n          webOnly: true,\n        });\n        return await action(projectRoot, normalizedOptions);\n      }\n    );\n};\n"],"file":"start.js"}